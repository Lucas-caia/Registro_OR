<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes do Registro</title>
  <link rel="stylesheet" href="/css/style.css">
  <!-- Biblioteca html2pdf via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="detail-container">
  <div class="detail-header">
    <h2>Detalhes do Registro</h2>
    <div style="display: flex; gap: 10px; align-items: center;">
      <span id="edit-button" class="icon-button">&#9881;</span>
      <img id="download-button" class="icon-button" src="/css/icons/download(1).png" alt="Download PDF">
    </div>
  </div>
  <div id="detail-content">Carregando...</div>
  <button class="button" id="back-button">Voltar</button>
</div>

<script>
  function getIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
  }

  function carregarDetalhes() {
    const registros = JSON.parse(localStorage.getItem("registros")) || [];
    const id = getIdFromUrl();
    const detailContent = document.getElementById("detail-content");

    if (id !== null && registros[id]) {
      const registro = registros[id];
      // Para os campos de listas, caso o registro tenha sido salvo como array, vamos juntar com vírgula.
      const formatList = (lista) => Array.isArray(lista) ? lista.join(", ") : lista;

      detailContent.innerHTML = `
          <div class="detail-field">
            <span class="detail-label">Nome:</span>
            <span class="detail-value">${registro.nome}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Vida Máxima:</span>
            <span class="detail-value">${registro.vidaMax}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Sanidade Máxima:</span>
            <span class="detail-value">${registro.sanidadeMax}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Esforço Máximo:</span>
            <span class="detail-value">${registro.esforcoMax}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Pontos de Missão (PM):</span>
            <span class="detail-value">${registro.pm}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Dinheiro:</span>
            <span class="detail-value">${registro.dinheiro}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Classe:</span>
            <span class="detail-value">${registro.classe}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Trilha:</span>
            <span class="detail-value">${registro.trilha}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Origem:</span>
            <span class="detail-value">${registro.origem}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Idade:</span>
            <span class="detail-value">${registro.idade}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Registro de Missões:</span>
            <span class="detail-value">${formatList(registro.missoes)}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Habilidades e Poderes:</span>
            <span class="detail-value">${formatList(registro.habilidades)}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Rituais:</span>
            <span class="detail-value">${formatList(registro.rituais)}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Data (Última modificação):</span>
            <span class="detail-value">${registro.data}</span>
          </div>
        `;
    } else {
      detailContent.innerHTML = `<p style="color: #ff4655; font-size: 18px;">Registro não encontrado.</p>`;
    }
  }

  // Função para gerar o PDF
  function generatePDF() {
    const element = document.querySelector(".detail-container");
    const opt = {
      margin:       0.5,
      filename:     'Detalhes_do_Registro.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  }

  document.addEventListener("DOMContentLoaded", () => {
    carregarDetalhes();

    const editButton = document.getElementById("edit-button");
    editButton.addEventListener("click", () => {
      const id = getIdFromUrl();
      if (id !== null) {
        window.open(`EditPage.html?id=${id}`, "Editar Registro", "width=600,height=600");
      } else {
        alert("Registro não encontrado para edição!");
      }
    });

    const backButton = document.getElementById("back-button");
    backButton.addEventListener("click", () => {
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = "PrincipalPage.html";
      }
    });

    const downloadButton = document.getElementById("download-button");
    downloadButton.addEventListener("click", generatePDF);
  });
</script>
</body>
</html>
